---
title: Assessment of the Public Health Danger and Economic Consequences of Severe
  Weather Events in the United States
author: "John Woods"
date: "07/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(tidyverse)
library(lubridate)
library(reshape2)
```

## Synopsis





## Introduction

Extreme weather events are a regular occurrence in the United States. In 2021 alone there were 20 'Billion-dollar disaster events' leading to 688 fatalities and causing $145 Billion in damage (NOAA, 2022). Being able to predict and better allocate resources to these events will enable the creation of data driven policies and protocols that could reduce this loss of life and economic damage and speed up recovery. The aim of this report is to provide actionable insight into these events and give recommendations on how resources could be prioritized based on them.


## Data Processing

This analysis will be using the US National Oceanic and Atmospheric Administration's (NOAA) storm database. The database tracks major storms and weather events across the United States, including when and where they occur along with estimates of any fatalities, injuries and property damage. The data can be downloaded from: https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2

We first read in the data which is comma delimited keeping the header data.

```{r cache = TRUE, message = FALSE}
storm_data <- read_csv("repdata_data_StormData.csv.bz2")
```
```{r}
dim(storm_data)
```
```{r}
head(storm_data)
```

The data contains observations of 902297 events consisting of 37 features for each. We aren't interested in all of these features so we'll drop those that are not relevant to our high level analysis. We'll also make the column names lower case so they are easier to type.

```{r}
names(storm_data) <- tolower(names(storm_data))
storm_data <- subset(storm_data, select = -c(bgn_time, time_zone, bgn_range, bgn_azi, bgn_locati,
                                             end_date, end_time, county_end, countyendn, 
                                             end_range, end_azi, end_locati, f, mag, length, width,
                                             stateoffic, zonenames, latitude_e, longitude_,
                                             remarks, refnum, latitude, longitude, wfo))
```

The values for property and crop damage consist of a value column and a column denoting if the value is in thousands/millions etc. We'll condense these columns to dollar amounts.

```{r}
table(storm_data['propdmgexp'])
```
We can safely assume B/M/K are billion/million/thousand however without documentation on the others the safest cause of action is to drop the rows containing them. 

```{r}
storm_data <- storm_data %>%
  mutate(propdmgexp = tolower(propdmgexp), cropdmgexp = tolower(cropdmgexp)) %>%
  filter(propdmgexp %in% c("b", "m", "k", NA) & cropdmgexp %in% c("b", "m", "k", NA)) %>%
  mutate(propdmgexp = case_when(propdmgexp == "k" ~ 1000,
                                propdmgexp == "m" ~ 1000000,
                                propdmgexp == "b" ~ 1000000000,
                                is.na(propdmgexp) ~ 1),
         cropdmgexp = case_when(cropdmgexp == "k" ~ 1000,
                                cropdmgexp == "m" ~ 1000000,
                                cropdmgexp == "b" ~ 1000000000,
                                is.na(cropdmgexp) ~ 1)) %>%
  mutate(propdmg = propdmg * propdmgexp, cropdmg = cropdmg * cropdmgexp) %>%
  subset(select = -c(propdmgexp, cropdmgexp))
```

Currently the date feature is a date time string set to midnight for each date. Let's isolate the date so it's easier to work with.

```{r}
storm_data <- storm_data %>%
  mutate(bgn_date = mdy(as.character(map(str_split(bgn_date, pattern = " "), 1))))
```

The dataset has 973 unique weather events. There are some errors in this feature including typos and values that aren't weather events, these need to be addressed before analysis. In addition due to a lack of standardization in the recording of the data many categories are worded slightly differently. 

```{r}

thunderstorm_winds <- c("thundeerstorm winds", "thunderestorm winds", "thunderstorm  winds", "thunderstorm w inds", "thunderstorm wind", "thunderstorm wins", "thunderstorms", "thunderstorms wind", "thunderstorms winds", "thunderstormw winds", "thunderstormwinds", "thunderstrom wind", "thunderstrom winds", "thundertorm winds", "thundertsorm wind", "thundestorm winds", "thunerstorm winds", "thunderstorm winds", "tstm wind", "tstm wnd")


storm_data <- storm_data %>%
  mutate(evtype = tolower(evtype)) %>%
  filter(!grepl("summary", evtype)) %>%
  filter(!evtype %in% c("?", "high", "none", "apache county")) %>%
  mutate(evtype = case_when(evtype %in% thunderstorm_winds ~ "thunderstorm wind",
                            grepl("forest fire", evtype) ~ "wildfires",
                            grepl("wildfire", evtype) ~ "wildfires",
                            grepl("wild fire", evtype) ~ "wildfires",
                            grepl("storm surge", evtype) ~ "storm surge",
                            grepl("tropical storm", evtype) ~ "tropical storm",
                            grepl("flash flood", evtype) ~ "flash flood",
                            grepl("rip current", evtype) ~ "rip current",
                            grepl("beach erosin", evtype) ~ "beach erosion",
                            grepl("hail", evtype) ~ "hail",
                            grepl("avalance", evtype) ~ "avalanche",
                            grepl("blizzard", evtype) ~ "blizzard",
                            grepl("thunderstorm wind", evtype) ~ "thunderstorm wind",
                            grepl("tstm wind", evtype) ~ "thunderstorm wind",
                            grepl("hurricane", evtype) ~ "hurricane",
                            TRUE ~ evtype))

```

Just by picking at the low hanging fruit the number of categories has been reduced to 622. We'll now do a more thorough EDA to assess what more can be done. Due to the event type imbalance in the dataset we'll use the average as our initial summary statistic. Lets look at the highest average loss of life first.

```{r}

events_summary <- storm_data %>%
  group_by(evtype) %>%
  summarise(count = n(), avg_fatalities = mean(fatalities), avg_injuries = mean(injuries), avg_propdmg = mean(propdmg), avg_cropdmg = mean(cropdmg))
events_summary[order(-events_summary$avg_fatalities),]
```
Many of these event categories have only a handful of events which is problematic.

```{r}
mean(head(events_summary$count, 50) < 3)
```
Half of the most deadly events have less than 3 occurrences. Looking at the data it's obvious many of these occur multiple times in the data but under different names, these are the high outliers. I looked at using word distances and clustering to condense them but due to similarity (eg "major flood", "minor flood") the category names are not a good candidate. An easy way to make the data more representative would be to only look at categories with larger numbers of occurrences. This makes the assumption that the observations of the same type are randomly distributed into different categories which might not be the case. We should bare this in mind if we're to carry out further statistical analysis. To make sure we still catch rare events lets look at those that occur at least 5 times in the dataset, lets also drop observations that are 0 in every column as they are of no interest to us.

```{r}
events_5 <- events_summary %>%
  filter(count >= 5, avg_fatalities > 0 | avg_injuries > 0 | avg_propdmg > 0 | avg_cropdmg > 0)
events_5[order(events_5$evtype),]
```
We've managed to go from 973 unique weather events to 157 whilst only reducing the number of observations by 0.12%! (1089)

## Exploratory Data Analysis

### Damage to human life

First we will look at events that cause the greatest loss of life and injury.

```{r}
events_5[order(-events_5$avg_fatalities),]

```
```{r}
events_5[order(-events_5$avg_injuries),]

```
Looking at these tables it seems that the data on fatalities is a better indicator of the danger to 
public health. Due to the complicated nature of measuring death against injury and the lack of information about injuries I'll use fatalities alone when assessing how harmful to population health an event is. 

From the data it seems like extreme heat events are the most harmful to population health but it would be a good idea to also look at the total fatalities for a given event in order to account for frequency.

```{r}
fatalities <- events_5 %>%
  summarise(evtype = evtype,  total_fatalities = count * avg_fatalities, avg_fatalities = avg_fatalities)
fatalities <- head(fatalities[order(-fatalities$total_fatalities), ], 10)
fatalities
```


```{r}
melted_fatalities <- melt(head(fatalities, 10)) %>%
  mutate(variable = case_when(variable == "total_fatalities" ~ "Total Fatalities",
                              variable == "avg_fatalities" ~ "Average Fatalities per Event"))



ggplot(data = melted_fatalities, aes(x = evtype, y = value)) +
  facet_grid(cols = vars(variable), scales = "free") +
  theme(strip.text.x = element_text(angle = 0))  +
  geom_bar(stat = "identity") +
  labs(title = "Average and Total Fatalaties for the 10 most Deadly Types of\nWeather Events in the United States 1950 - 2011", x = "", y = "") +
  coord_flip() 
  
```
Including the total fatalities per event type shows us that tornadoes have caused the largest number of fatalities in the US over the period by a large margin. If we were to collate all heat related events into one category this margin would be reduced and possibly reversed, however doing so would be outside the scope of this analysis.


### Economic Damage

Whilst one could rightly argue that the loss of human life in itself is a form of economic damage we will only be regarding damage to property and crops in this analysis.

As both property and crop damage are measured in dollar amounts we will simply combine them to address the economic damage

```{r}
economic_damage <- events_5 %>%
  summarise(evtype = evtype, economic_damage = count * avg_propdmg + count * avg_cropdmg)
economic_damage[order(-economic_damage$economic_damage),]
```





NOAA National Centers for Environmental Information (NCEI) U.S. Billion-Dollar Weather and Climate Disasters (2022). https://www.ncdc.noaa.gov/billions/, DOI: 10.25921/stkw-7w73